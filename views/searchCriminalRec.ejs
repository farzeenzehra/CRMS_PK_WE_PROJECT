<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('partials/head.ejs') %>
    
    <title>Criminal Record</title>

</head>

<body>

  <div class="page-wrapper chiller-theme toggled">

    <%- include ('partials/header.ejs') %>
      <main class="page-content mt-5">
        <div class="container-fluid">
          <h2>Search Criminal Records</h2>
          <hr>
          <div class="container py-3">
            <!-- alert -->
            <div class="alert" role="alert" id="notifAlert" style="display: none;">
            </div>
            <!-- alert -->
            <div class="input-group mb-3 d-flex flex-wrap">
              <div class="input-group-prepend">
                <label class="input-group-text bg-dark text-white" for="selectionGrp">Search By</label>
              </div>
              <select class="custom-select" id="selectionGrp" required>
                <option value="" disabled selected hidden>Please Choose...</option>
                <option value="cId">Criminal ID</option>
                <option value="cName">Criminal Name</option>
                <option value="cnic">CNIC</option>
                <option value="lang">Language</option>
                <option value="moi">Marks of Identification</option>
                <option value="crId">Crime ID</option>
                <option value="crName">Crime Name</option>
                <option value="jailNo">Jail No.</option>
                <option value="firNo">FIR No.</option>
                <option value="caseNo">Case No.</option>
              </select>
            </div>
            <input type="text" class="form-control" id="searchField" placeholder="Select Option Above" disabled
              required>
            <div id="resultsDiv" class="my-3" style="overflow: scroll;">

            </div>
          </div>
        </div>
      </main>
      <!-- page-content" -->
  </div>
          <!-- Full Record Modal -->
          <div class="modal fade" data-backdrop="static" id="fullRecordModal" tabindex="-1" role="dialog"
          aria-labelledby="fullRecordModalTitle" aria-hidden="true">
          <div class="modal-dialog  modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="fullRecordModalLongTitle">Full Criminal Record</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="p-3 mb-3 bg-dark text-white rounded h6">Criminal Information</div>
                <div id="criminalInfo" class="p-4 border rounded border-dark">
                  <div class="row">
                    <div class="col-sm-9">
                      <div id="criminalInfoForm">
                        <div class="row">
                          <label for="CriminalID" class="col-sm-2 col-form-label"><b>Criminal
                              ID</b></label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control-plaintext border pl-3 rounded" id="CriminalID"
                              placeholder="Criminal ID" readonly readonly>
                          </div>
                        </div>
                        <div class="mt-4 row">
                          <label for="CNIC" class="col-sm-2 col-form-label"><b>CNIC</b></label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control-plaintext border pl-3 rounded" id="CNIC"
                              placeholder="CNIC" readonly>
                          </div>
                        </div>
                        <div class="mt-4 row">
                          <label for="FullName" class="col-sm-2 col-form-label"><b>Full
                              Name</b></label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control-plaintext border pl-3 rounded" id="FullName"
                              placeholder="Person's Name" readonly>
                          </div>
                        </div>
                        <div class="mt-4 row">
                          <label for="Height" class="col-sm-2 col-form-label"><b>Height</b></label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control-plaintext border pl-3 rounded" id="Height"
                              placeholder="Height in cm [ex:140.0]" readonly>
                          </div>
                        </div>
                        <div class="mt-4 row">
                          <label for="Weight" class="col-sm-2 col-form-label"><b>Weight</b></label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control-plaintext border pl-3 rounded" id="Weight"
                              placeholder="Weight in kg [ex: 70.0]" readonly>
                          </div>
                        </div>
                        <div class="mt-4 row">
                          <label for="Complexion" class="col-sm-2 col-form-label"><b>Complexion</b></label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control-plaintext border pl-3 rounded" id="Complexion"
                              placeholder="Complexion" readonly>
                          </div>
                        </div>

                        <div class="mt-4 row">
                          <label for="HairColor" class="col-sm-2 col-form-label"><b>Hair
                              Color</b></label>
                          <div class="col-sm-4">
                            <input type="text" class="form-control-plaintext border pl-3 rounded" id="HairColor"
                              placeholder="Hair Color" readonly>
                          </div>
                          <label for="EyeColor" class="col-sm-2 col-form-label"><b>Eye
                              Color</b></label>
                          <div class="col-sm-4">
                            <input type="text" class="form-control-plaintext border pl-3 rounded" id="EyeColor"
                              placeholder="Eye Color" readonly>
                          </div>
                        </div>
                        <div class="mt-4 row">
                          <label for="Lang" class="col-sm-2 col-form-label"><b>Languages</b></label>
                          <div class="col-sm-10">
                            <textarea type="text" class="form-control-plaintext border pl-3 rounded" id="Lang"
                              placeholder="Languages" readonly></textarea>
                          </div>
                        </div>
                        <div class="mt-4 row">
                          <label for="MOI" class="col-sm-2 col-form-label"><b>Marks of
                              Identification</b></label>
                          <div class="col-sm-10">
                            <textarea type="text" class="form-control-plaintext border pl-3 rounded" id="MOI"
                              placeholder="Marks of Identification" readonly></textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-3">
                      <div class="row">

                        <div class="card m-2" style="width: 11rem;">
                          <div class="card-body">
                            <label for="front-img-holder"><b>Front Profile Image</b></label>
                            <img id="front-img-holder" class="card-img-top" src="images/unknownSampleImg.png"
                              alt="person's image">
                          </div>
                        </div>

                        <div class="card m-2" style="width: 11rem;">
                          <div class="card-body">
                            <label for="left-img-holder"><b>Left Profile Image</b></label>
                            <img id="left-img-holder" class="card-img-top" src="images/unknownSampleImg.png"
                              alt="person's image">
                          </div>
                        </div>

                        <div class="card m-2" style="width: 11rem;">
                          <div class="card-body">
                            <label for="right-img-holder"><b>Right Profile Image</b></label>
                            <img id="right-img-holder" class="card-img-top" src="images/unknownSampleImg.png"
                              alt="person's image">
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>

                <div class="p-3 my-3 bg-dark text-white rounded h6">Crimes Information</div>
                <div class="mt-2 p-4 border rounded border-dark" id="crimesInfo">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" onclick="generatePDF();" class="btn btn-primary">Save as pdf</button>
              </div>
            </div>
          </div>
        </div>
  <!-- page-wrapper -->
  <%- include('partials/foot.ejs') %>
    <script type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script>
      function generatePDF() {
        // Choose the element that our invoice is rendered in.
        $('details').attr('open', true);
        const element = document.getElementsByClassName("modal-body")[0];
        // Choose the element and save the PDF for our user.
        let opt = {
          margin: [0.5, 0],
          filename: `${'Crimnal Record No ' + $('#CriminalID').val()}.pdf`,
          image: { type: 'png', quality: 1 },
          jsPDF: { unit: 'in', format: 'A4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
      }
      $('#resultsDiv').on('click','.viewFullCriminalRecord', function (e) {
        e.preventDefault();
        $('#notifAlert').removeClass('alert-danger');
        $('#notifAlert').addClass('alert-info');
        $('#notifAlert').text("Please Wait! Fetching Results");
        $('#notifAlert').show();
        // $('.modal-body').text(e.target.id);
        // $('#fullRecordModal').modal('show');
        let criminal_id = e.target.id;
        $.ajax(
          {
            type: 'GET',
            url: '/get_full_criminal_record',
            dataType: 'json',
            xhrFields: {
              withCredentials: true
            },
            data: {
              "id": criminal_id
            },
            success: function (records) {
              $('#FullName').val(records.criminal.FullName);
              $('#CNIC').val(records.criminal.CNIC);
              $('#CriminalID').val(records.criminal.CriminalID);
              $('#Height').val(records.criminal.Height);
              $('#Weight').val(records.criminal.Weight);
              $('#Complexion').val(records.criminal.Complexion);
              $('#HairColor').val(records.criminal.HairColor);
              $('#EyeColor').val(records.criminal.EyeColor);
              $('#Lang').val(records.criminal.Languages);
              $('#MOI').val(records.criminal.IdentificationMarks);
              $('#front-img-holder').attr('src', records.criminal.frontProfile);
              $('#left-img-holder').attr('src', records.criminal.leftProfile);
              $('#right-img-holder').attr('src', records.criminal.rightProfile);

              // for (const key in records.criminal) {
              //   document.getElementsByCId('crimesInfo').innerHTML +=
              //     `
              // <p>${key}: ${records.criminal[key]}</p>
              // `
              // }
              let n = 1;
              document.getElementById('crimesInfo').innerHTML = '';
              records.crimes.forEach(crime => {
                let details = '';
                for (const key in crime) {
                  details += `<p><b>${key}: </b>${crime[key]}</p>`
                }
                document.getElementById('crimesInfo').innerHTML +=
                  `<li class="list-group-item list-group-item-action py-2 d-flex justify-content-between">
                        <details>
                            <summary><b>Crime No. ${n}</b></summary>
                            <p>${details}</p>
                        </details>
                    </li>`;
                n++;
              })
              $('#notifAlert').hide();
              $('#fullRecordModal').modal('show');

            },
            error: function (err) {
              $('#notifAlert').removeClass('alert-info');
              $('#notifAlert').addClass('alert-danger');
              $('#notifAlert').text("Ooops! Some error occurred");
              $('#notifAlert').show().delay(5000).fadeOut();
            }

          }
        )

      })

      function fetchResults() {
        let alertMsg = `<div class="alert alert-info" role="alert">
          Fetching Results . . .
        </div>`
        document.getElementById('resultsDiv').innerHTML = alertMsg;
        $.ajax({
          type: 'get',
          url: '/get_results_search_criminal_rec',
          xhrFields: {
            withCredentials: true
          },
          data:
          {
            "selectedGrp": $('#selectionGrp').val(),
            "searchQuery": $('#searchField').val()
          },
          success: function (records) {
            document.getElementById('resultsDiv').innerHTML =
              `
            <div class="p-3 mb-3 bg-dark text-white rounded h6">Results [${$('#selectionGrp option:selected').text()} : ${$('#searchField').val()}]</div>
            <table class="table table-hover">
              <thead class="bg-dark">
                <tr>
                  <th scope="col">Criminal ID</th>
                  <th scope="col">CNIC</th>
                  <th scope="col">Name</th>
                  <th scope="col">No. of Crimes</th>
                  <th scope="col">View</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
              </table>
            `
            records.forEach(record => {
              if (record.CriminalID != null) {
                let tr = document.createElement('tr');
                tr.innerHTML =
                  `
                    <th scope="row">${record.CriminalID}</th>
                    <td>${record.CNIC}</td>
                    <td>${record.FullName}</td>
                    <td>${record.CrimesDone}</td>
                    <td><a href="#" class="viewFullCriminalRecord">
                        <i id="${record.CriminalID}" class="fas fa-external-link-alt"></i>
                      </a></td>
                  `
                document.querySelector(".table tbody").append(tr)
              }
              else {
                document.getElementById('resultsDiv').innerHTML =
                  `<div class="p-3 mb-3 bg-dark text-white rounded h6">No Result Found [${$('#selectionGrp option:selected').text()} : ${$('#searchField').val()}]</div>`
              }
              $('html, body').animate({ scrollTop: $("#resultsDiv").offset().top }, 1000);
            });
          }
        });
      }
      $('#selectionGrp').on('change', function (e) {
        $('#searchField').removeAttr('disabled');
        $('#searchField').attr('placeholder', "Enter " + $('#selectionGrp option:selected').text());
        fetchResults();
      });
      $('#searchField').on('input', function (e) {
        fetchResults();
      });
    </script>



</body>

</html>